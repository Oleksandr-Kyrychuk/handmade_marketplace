#!/usr/bin/make

DOCKER_COMPOSE_BIN := $(shell command -v docker-compose 2>/dev/null || echo "docker compose")

# –ó–∞–ø—É—Å–∫ —É—Å—ñ—Ö —Å–µ—Ä–≤—ñ—Å—ñ–≤
up:
	@echo "üöÄ –ó–∞–ø—É—Å–∫ —É—Å—ñ—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ñ–≤ (api_gateway, user_service, marketplace_database, redis)..."
	$(DOCKER_COMPOSE_BIN) -f docker-compose.local.yml up -d --build
	@echo "‚è≥ –û—á—ñ–∫—É–≤–∞–Ω–Ω—è –∑–∞–ø—É—Å–∫—É —Å–µ—Ä–≤—ñ—Å—ñ–≤..."
	@sleep 10
	@echo "‚úÖ –í—Å—ñ —Å–µ—Ä–≤—ñ—Å–∏ –∑–∞–ø—É—â–µ–Ω—ñ!"

# –ó–∞–ø—É—Å–∫ –ª–∏—à–µ api_gateway
gate:
	@echo "üöÄ –ó–∞–ø—É—Å–∫ api_gateway..."
	$(DOCKER_COMPOSE_BIN) -f docker-compose.local.yml up -d api-gateway
	@echo "‚è≥ –û—á—ñ–∫—É–≤–∞–Ω–Ω—è –∑–∞–ø—É—Å–∫—É api_gateway..."
	@sleep 5
	@echo "‚úÖ api_gateway –∑–∞–ø—É—â–µ–Ω–æ!"

# –ó–∞–ø—É—Å–∫ –ª–∏—à–µ user_service
user:
	@echo "üöÄ –ó–∞–ø—É—Å–∫ user_service..."
	$(DOCKER_COMPOSE_BIN) -f docker-compose.local.yml up -d user_service
	@echo "‚è≥ –û—á—ñ–∫—É–≤–∞–Ω–Ω—è –∑–∞–ø—É—Å–∫—É user_service..."
	@sleep 5
	@echo "‚úÖ user_service –∑–∞–ø—É—â–µ–Ω–æ!"

# –ó—É–ø–∏–Ω–∫–∞ –≤—Å—ñ—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ñ–≤
down:
	@echo "üõë –ó—É–ø–∏–Ω–∫–∞ –≤—Å—ñ—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ñ–≤..."
	$(DOCKER_COMPOSE_BIN) -f docker-compose.local.yml down

# –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —É—Å—ñ—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ñ–≤
restart: down up
	@echo "üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —É—Å—ñ—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ñ–≤ –≤–∏–∫–æ–Ω–∞–Ω–æ!"

# –í–∏–≤–µ–¥–µ–Ω–Ω—è –ª–æ–≥—ñ–≤ –≤—Å—ñ—Ö —Å–µ—Ä–≤—ñ—Å—ñ–≤
logs:
	$(DOCKER_COMPOSE_BIN) -f docker-compose.local.yml logs -f

# –ü–æ–∫–∞–∑–∞—Ç–∏ –∞–∫—Ç–∏–≤–Ω—ñ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∏
ps:
	$(DOCKER_COMPOSE_BIN) -f docker-compose.local.yml ps

# –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –º—ñ–≥—Ä–∞—Ü—ñ–π
makemigrations:
	@echo "üõ† –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –Ω–æ–≤–∏—Ö –º—ñ–≥—Ä–∞—Ü—ñ–π –¥–ª—è user_service..."
	$(DOCKER_COMPOSE_BIN) -f docker-compose.local.yml exec user_service python manage.py makemigrations

# –í–∏–∫–æ–Ω–∞–Ω–Ω—è –º—ñ–≥—Ä–∞—Ü—ñ–π
migrate:
	@echo "üîÑ –í–∏–∫–æ–Ω–∞–Ω–Ω—è –º—ñ–≥—Ä–∞—Ü—ñ–π –¥–ª—è user_service..."
	$(DOCKER_COMPOSE_BIN) -f docker-compose.local.yml exec user_service python manage.py migrate

# –°—Ç–≤–æ—Ä–µ–Ω–Ω—è —Å—É–ø–µ—Ä–∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
super:
	@echo "üë§ –°—Ç–≤–æ—Ä–µ–Ω–Ω—è —Å—É–ø–µ—Ä–∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –¥–ª—è user_service..."
	$(DOCKER_COMPOSE_BIN) -f docker-compose.local.yml exec user_service python manage.py createsuperuser